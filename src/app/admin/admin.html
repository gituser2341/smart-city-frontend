<div class="dashboard">

  <!-- Header -->
  <header class="header">
    <div class="header-left">
      <div class="admin-icon">ğŸ›¡ï¸</div>
      <div>
        <h1 class="header-title">Admin Dashboard</h1>
        <p class="header-sub">Smart City Governance</p>
      </div>
    </div>
    <div class="header-right">
      <button class="btn-add" routerLink="/add-officer">+ Add Officer</button>
      <button class="btn-logout" (click)="logout()">â‹ Logout</button>
    </div>
  </header>

  <!-- Loading -->
  <div class="loading-state" *ngIf="isLoading">
    <div class="spinner"></div>
    <p>Loading dashboard...</p>
  </div>

  <div *ngIf="!isLoading">

    <!-- Top Stats -->
    <section class="stats-grid">
      <div class="stat-card stat-total">
        <div class="stat-icon">ğŸ“‹</div>
        <div class="stat-number">{{ stats.totalComplaints }}</div>
        <div class="stat-label">Total Complaints</div>
      </div>
      <div class="stat-card stat-open">
        <div class="stat-icon">ğŸ”´</div>
        <div class="stat-number">{{ stats.byStatus?.OPEN }}</div>
        <div class="stat-label">Open</div>
      </div>
      <div class="stat-card stat-progress">
        <div class="stat-icon">âš™ï¸</div>
        <div class="stat-number">{{ stats.byStatus?.IN_PROGRESS }}</div>
        <div class="stat-label">In Progress</div>
      </div>
      <div class="stat-card stat-resolved">
        <div class="stat-icon">âœ…</div>
        <div class="stat-number">{{ stats.byStatus?.RESOLVED }}</div>
        <div class="stat-label">Resolved</div>
      </div>
      <div class="stat-card stat-officers">
        <div class="stat-icon">ğŸ‘®</div>
        <div class="stat-number">{{ stats.totalOfficers }}</div>
        <div class="stat-label">Officers</div>
      </div>
      <div class="stat-card stat-citizens">
        <div class="stat-icon">ğŸ‘¤</div>
        <div class="stat-number">{{ stats.totalCitizens }}</div>
        <div class="stat-label">Citizens</div>
      </div>
    </section>

    <!-- Tabs -->
    <div class="tabs">
      <button class="tab-btn" [ngClass]="{'tab-active': activeTab === 'dashboard'}"
        (click)="setTab('dashboard')">ğŸ“Š Analytics</button>
      <button class="tab-btn" [ngClass]="{'tab-active': activeTab === 'complaints'}"
        (click)="setTab('complaints')">ğŸ“‹ Complaints</button>
    </div>

    <!-- ANALYTICS TAB -->
    <div class="tab-content" *ngIf="activeTab === 'dashboard'">

      <div class="charts-grid">

        <!-- Department Chart -->
        <div class="chart-card">
          <h3 class="chart-title">ğŸ“Š Complaints by Department</h3>
          <div class="bar-chart">
            <div class="bar-row" *ngFor="let dept of ['WATER','ELECTRICITY','SANITATION','ROAD']">
              <div class="bar-label">
                <span class="bar-emoji">
                  {{ dept === 'WATER' ? 'ğŸ’§' : dept === 'ELECTRICITY' ? 'âš¡' : dept === 'SANITATION' ? 'ğŸ—‘ï¸' : 'ğŸ›£ï¸' }}
                </span>
                {{ dept }}
              </div>
              <div class="bar-track">
                <div class="bar-fill bar-blue"
                  [style.width]="getBarWidth(stats.byDepartment?.[dept] || 0, getMaxDept())">
                </div>
              </div>
              <div class="bar-value">{{ stats.byDepartment?.[dept] || 0 }}</div>
            </div>
          </div>
        </div>

        <!-- Priority Chart -->
        <div class="chart-card">
          <h3 class="chart-title">ğŸš¨ Complaints by Priority</h3>
          <div class="bar-chart">
            <div class="bar-row">
              <div class="bar-label">ğŸ”´ EMERGENCY</div>
              <div class="bar-track">
                <div class="bar-fill bar-red"
                  [style.width]="getBarWidth(stats.byPriority?.EMERGENCY || 0, getMaxPriority())">
                </div>
              </div>
              <div class="bar-value">{{ stats.byPriority?.EMERGENCY || 0 }}</div>
            </div>
            <div class="bar-row">
              <div class="bar-label">ğŸŸ  HIGH</div>
              <div class="bar-track">
                <div class="bar-fill bar-orange"
                  [style.width]="getBarWidth(stats.byPriority?.HIGH || 0, getMaxPriority())">
                </div>
              </div>
              <div class="bar-value">{{ stats.byPriority?.HIGH || 0 }}</div>
            </div>
            <div class="bar-row">
              <div class="bar-label">ğŸŸ¡ MEDIUM</div>
              <div class="bar-track">
                <div class="bar-fill bar-yellow"
                  [style.width]="getBarWidth(stats.byPriority?.MEDIUM || 0, getMaxPriority())">
                </div>
              </div>
              <div class="bar-value">{{ stats.byPriority?.MEDIUM || 0 }}</div>
            </div>
            <div class="bar-row">
              <div class="bar-label">ğŸŸ¢ LOW</div>
              <div class="bar-track">
                <div class="bar-fill bar-green"
                  [style.width]="getBarWidth(stats.byPriority?.LOW || 0, getMaxPriority())">
                </div>
              </div>
              <div class="bar-value">{{ stats.byPriority?.LOW || 0 }}</div>
            </div>
          </div>
        </div>

        <!-- Status Donut -->
        <div class="chart-card">
          <h3 class="chart-title">ğŸ“ˆ Resolution Rate</h3>
          <div class="donut-section">
            <div class="donut-ring">
              <svg viewBox="0 0 100 100" class="donut-svg">
                <circle cx="50" cy="50" r="40" fill="none" stroke="#f1f5f9" stroke-width="12"/>
                <circle cx="50" cy="50" r="40" fill="none" stroke="#22c55e" stroke-width="12"
                  stroke-dasharray="251.2"
                  [attr.stroke-dashoffset]="251.2 - (251.2 * (stats.byStatus?.RESOLVED || 0) / (stats.totalComplaints || 1))"
                  stroke-linecap="round"
                  transform="rotate(-90 50 50)"/>
              </svg>
              <div class="donut-center">
                <span class="donut-pct">
                  {{ stats.totalComplaints ? ((stats.byStatus?.RESOLVED / stats.totalComplaints) * 100 | number:'1.0-0') : 0 }}%
                </span>
                <span class="donut-sub">Resolved</span>
              </div>
            </div>
            <div class="donut-legend">
              <div class="legend-item">
                <span class="legend-dot dot-red"></span>
                <span>Open: {{ stats.byStatus?.OPEN || 0 }}</span>
              </div>
              <div class="legend-item">
                <span class="legend-dot dot-blue"></span>
                <span>In Progress: {{ stats.byStatus?.IN_PROGRESS || 0 }}</span>
              </div>
              <div class="legend-item">
                <span class="legend-dot dot-green"></span>
                <span>Resolved: {{ stats.byStatus?.RESOLVED || 0 }}</span>
              </div>
            </div>
          </div>
        </div>

        <!-- Officers List -->
        <div class="chart-card">
          <h3 class="chart-title">ğŸ‘® Officers by Department</h3>
          <div class="officers-list">
            <div class="officer-row" *ngFor="let o of officers">
              <div class="officer-avatar">{{ o.name?.charAt(0) }}</div>
              <div class="officer-info">
                <span class="officer-name">{{ o.name }}</span>
                <span class="officer-dept">{{ o.department || 'Unassigned' }}</span>
              </div>
              <span class="officer-dept-badge"
                [ngClass]="{
                  'dept-water': o.department === 'WATER',
                  'dept-elec':  o.department === 'ELECTRICITY',
                  'dept-san':   o.department === 'SANITATION',
                  'dept-road':  o.department === 'ROAD'
                }">
                {{ o.department === 'WATER' ? 'ğŸ’§' : o.department === 'ELECTRICITY' ? 'âš¡' : o.department === 'SANITATION' ? 'ğŸ—‘ï¸' : 'ğŸ›£ï¸' }}
              </span>
            </div>
            <div class="empty-officers" *ngIf="officers.length === 0">
              No officers added yet
            </div>
          </div>
        </div>

      </div>
    </div>

    <!-- COMPLAINTS TAB -->
    <div class="tab-content" *ngIf="activeTab === 'complaints'">
      <div class="complaints-list">

        <div class="empty-state" *ngIf="complaints.length === 0">
          <div class="empty-icon">ğŸ“­</div>
          <p>No complaints yet</p>
        </div>

        <div *ngFor="let c of complaints" class="complaint-card"
          [ngClass]="{'card-emergency': c.priority === 'EMERGENCY'}">

          <div class="complaint-header">
            <h3 class="complaint-title">{{ c.title }}</h3>
            <div class="badges">
              <span class="status-badge"
                [ngClass]="{
                  'status-open':     c.status === 'OPEN',
                  'status-progress': c.status === 'IN_PROGRESS',
                  'status-resolved': c.status === 'RESOLVED'
                }">{{ c.status }}</span>
              <span class="priority-badge"
                [ngClass]="{
                  'p-low':       c.priority === 'LOW',
                  'p-medium':    c.priority === 'MEDIUM',
                  'p-high':      c.priority === 'HIGH',
                  'p-emergency': c.priority === 'EMERGENCY'
                }">{{ c.priority }}</span>
            </div>
          </div>

          <p class="complaint-desc">{{ c.description }}</p>

          <div class="complaint-meta">
            <span class="meta-item">ğŸ¢ {{ c.department }}</span>
            <span class="meta-item">ğŸ‘¤ {{ c.user?.name }}</span>
            <span class="meta-item">ğŸ• {{ c.createdAt | date: 'dd MMM yyyy' }}</span>
            <span class="meta-item" *ngIf="c.assignedOfficer">
              ğŸ‘® {{ c.assignedOfficer?.name }}
            </span>
          </div>

          <!-- Assign Officer -->
          <div class="assign-section" *ngIf="c.status === 'OPEN'">
            <span class="assign-label">Assign Officer:</span>
            <select class="assign-select"
              [(ngModel)]="selectedOfficerId[c.id]">
              <option value="" disabled selected>Select officer</option>
              <option *ngFor="let o of officers"
                [value]="o.id">
                {{ o.name }} ({{ o.department }})
              </option>
            </select>
            <button class="btn-assign" (click)="assignOfficer(c.id)">
              Assign
            </button>
          </div>

        </div>
      </div>
    </div>

  </div>
</div>